# Promtail Helm values
# Loki 3.x와 함께 사용

config:
  # Loki 서버 설정
  clients:
    - url: http://loki:3100/loki/api/v1/push

  # 위치 파일
  positions:
    filename: /tmp/positions.yaml

  # 로그 수집 설정
  scrape_configs:
    - job_name: kubernetes-pods
      kubernetes_sd_configs:
        - role: pod

      pipeline_stages:
        - cri: {}
        - json:
            expressions:
              level: level
              msg: message
              timestamp: timestamp
        - labels:
            level:
        - timestamp:
            format: RFC3339Nano
            source: timestamp

      relabel_configs:
        # titanium-prod와 monitoring Namespace만 수집
        - action: keep
          regex: (titanium-prod|monitoring)
          source_labels:
            - __meta_kubernetes_namespace

        # 레이블 추가
        - source_labels:
            - __meta_kubernetes_namespace
          target_label: namespace

        - source_labels:
            - __meta_kubernetes_pod_name
          target_label: pod

        - source_labels:
            - __meta_kubernetes_pod_container_name
          target_label: container

        - source_labels:
            - __meta_kubernetes_pod_label_app
          target_label: app

        - separator: /
          source_labels:
            - __meta_kubernetes_namespace
            - __meta_kubernetes_pod_label_app
          target_label: job

        # 로그 파일 경로 설정
        - replacement: /var/log/pods/*$1/*.log
          separator: /
          source_labels:
            - __meta_kubernetes_pod_uid
            - __meta_kubernetes_pod_container_name
          target_label: __path__

  server:
    grpc_listen_port: 0
    http_listen_port: 9080

# 리소스 제한
resources:
  limits:
    cpu: 200m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi

# 모든 Node에 배포
tolerations:
  - effect: NoSchedule
    operator: Exists

# ServiceMonitor 활성화
serviceMonitor:
  enabled: true
  labels:
    release: prometheus
