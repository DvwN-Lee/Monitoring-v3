# Titanium Microservices Cloud 환경 테스트 결과

**테스트 일시**: 2026-01-22
**테스트 목적**: PR #73 (Kiali 자동 접속 스크립트) 머지 후 전체 시스템 상태 검증

---

## 테스트 결과 요약

| 항목 | 결과 | 상세 |
|------|------|------|
| Pod 상태 | PASS | 모든 Pod Running |
| Health Check | PASS | 모든 서비스 정상 응답 |
| Prometheus Targets | PASS | 17/26 UP (시스템 target 정상) |
| Kiali | PASS | v2.4.0 정상 동작 |
| Grafana | PASS | v12.2.1 정상 동작 |
| Istio CSR | PASS | 인증서 발급 성공 |
| NetworkPolicy | PARTIAL | Istiod egress OK, Blog→Auth egress 누락 |
| E2E 사용자 등록 | PASS | 201 Created |
| E2E 로그인 | PASS | JWT 토큰 발급 |
| E2E 토큰 검증 | PASS | 200 OK |
| E2E 블로그 CRUD | PARTIAL | 읽기 OK, 쓰기 502 (NetworkPolicy 문제) |

**전체 결과: PARTIAL PASS** - Blog Service NetworkPolicy 수정 필요

---

## 1. Pod 상태

### titanium-prod Namespace

| Pod | Ready | Status | Restarts | Node |
|-----|-------|--------|----------|------|
| prod-api-gateway-deployment-667fbcb8c4-b97ll | 2/2 | Running | 0 | master |
| prod-api-gateway-deployment-667fbcb8c4-gm455 | 2/2 | Running | 0 | worker |
| prod-auth-service-deployment-bb54c674f-2vlkd | 2/2 | Running | 0 | worker |
| prod-auth-service-deployment-bb54c674f-mzqjj | 2/2 | Running | 0 | master |
| prod-blog-service-deployment-65c765588f-j2827 | 2/2 | Running | 0 | master |
| prod-blog-service-deployment-65c765588f-j5dh5 | 2/2 | Running | 0 | worker |
| prod-postgresql-0 | 1/1 | Running | 0 | worker |
| prod-redis-deployment-764c6b94b5-bjzzd | 2/2 | Running | 133 | worker |
| prod-user-service-deployment-7684dbbb5c-kvg65 | 2/2 | Running | 0 | master |
| prod-user-service-deployment-7684dbbb5c-m2cnx | 2/2 | Running | 0 | worker |

### istio-system Namespace

| Pod | Ready | Status |
|-----|-------|--------|
| istio-ingressgateway-56878bcf99-74ht4 | 1/1 | Running |
| istiod-7f6c4c7568-598cw | 1/1 | Running |
| kiali-649bf57746-n8kp6 | 1/1 | Running |

### monitoring Namespace

| Pod | Ready | Status |
|-----|-------|--------|
| alertmanager-prometheus-kube-prometheus-alertmanager-0 | 2/2 | Running |
| loki-0 | 1/1 | Running |
| loki-promtail-2w7pn | 1/1 | Running |
| loki-promtail-xcm2r | 1/1 | Running |
| prometheus-grafana-7676766689-ln6vj | 2/2 | Running |
| prometheus-kube-prometheus-operator-787c69dfc5-rspwj | 1/1 | Running |
| prometheus-kube-state-metrics-7bbd865dd5-4bbcd | 1/1 | Running |
| prometheus-prometheus-kube-prometheus-prometheus-0 | 2/2 | Running |
| prometheus-prometheus-node-exporter-dgrwc | 1/1 | Running |
| prometheus-prometheus-node-exporter-fvtfs | 1/1 | Running |

---

## 2. Application Health Check

```
User Service:  {"status":"healthy"}
Auth Service:  {"status":"ok","service":"auth-service"}
Blog Service:  {"status":"ok","service":"blog-service"}
```

---

## 3. Monitoring Stack

### Prometheus Targets

- **UP**: 17
- **DOWN**: 9 (모두 `prod-envoy-stats-monitor`)
- **TOTAL**: 26

DOWN target 분석:
- `titanium-prod/prod-envoy-stats-monitor` x9
- Envoy stats scraping 관련 issue로, 핵심 시스템 target은 모두 UP

### Kiali

```json
{
    "status": {
        "Kiali container version": "v2.4.0",
        "Kiali state": "running"
    },
    "externalServices": [
        {"name": "Kubernetes-Kubernetes", "version": "v1.34.3+k3s1"},
        {"name": "Prometheus", "version": "3.7.3"},
        {"name": "Grafana", "url": "http://prometheus-grafana.monitoring:80"}
    ]
}
```

### Grafana

```json
{
  "database": "ok",
  "version": "12.2.1"
}
```

---

## 4. Istio Service Mesh

### istio-proxy CSR

```
2026-01-21T15:21:02.590889Z  info  cache  generated new workload certificate
resourceName=default latency=1.288256724s ttl=23h59m59.40913479s
```

인증서 발급 성공 확인.

### PeerAuthentication

- `prod-default-mtls`: STRICT mTLS
- `prod-postgresql-mtls-disable`: PostgreSQL mTLS DISABLE (의도된 설정)

### NetworkPolicy Istiod Egress

모든 서비스의 NetworkPolicy에 Istiod egress 규칙 적용 확인:
- Port 15012 (xDS-grpc)
- Port 15010 (xDS-grpc-cleartext)

적용된 NetworkPolicy:
- api-gateway-network-policy
- auth-service-network-policy
- blog-service-network-policy
- postgresql-network-policy
- redis-network-policy
- user-service-network-policy

---

## 5. 최근 적용 변경 사항

| PR | 내용 | 상태 |
|----|------|------|
| #69 | istio-proxy graceful shutdown 설정 | 적용 완료 |
| #71 | NetworkPolicy Istiod egress 규칙 | 적용 완료 |
| #73 | Kiali 자동 접속 스크립트 | 머지 완료 |

---

## 6. 참고 사항

### Redis Restarts (133회)

- Redis Pod restart 횟수가 높음
- 이전 테스트에서도 관찰된 현상
- 현재 정상 동작 중 (2/2 Running)
- 필요시 리소스 할당 검토 권장

### Envoy Stats Monitor DOWN

- 9개 target DOWN 상태
- Application Pod의 Envoy sidecar stats scraping 관련
- mTLS STRICT 환경에서 발생할 수 있는 현상
- 핵심 모니터링 기능에는 영향 없음

---

## 7. E2E Service 테스트 (API 요청)

**테스트 시간**: 2026-01-22 12:30 KST

### 테스트 환경

| 항목 | 값 |
|------|-----|
| 접근 방식 | kubectl port-forward |
| IngressGateway | NodePort (HTTP: 31080, HTTPS: 31443) |
| TLS | HTTPS redirect 활성화 |

### 테스트 결과 요약

| 테스트 항목 | HTTP Status | 결과 | 비고 |
|------------|-------------|------|------|
| Blog Service Health | 200 | PASS | |
| User Service 등록 | 201 | PASS | |
| Auth Service 로그인 | 200 | PASS | JWT 토큰 발급 |
| Auth Service 토큰 검증 | 200 | PASS | |
| Blog Service 포스트 목록 | 200 | PASS | 빈 배열 반환 |
| Blog Service 포스트 생성 | 502 | **FAIL** | NetworkPolicy 문제 |

### 테스트 상세

#### 1. Blog Service Health Check

```bash
curl -s http://localhost:18005/health
```

```json
{"status":"ok","service":"blog-service"}
```

#### 2. User Service 사용자 등록

```bash
curl -X POST http://localhost:18001/users \
  -H "Content-Type: application/json" \
  -d '{"username": "e2e_test_user", "email": "e2e_test@example.com", "password": "TestPass123@"}'
```

```json
{"id":1,"username":"e2e_test_user","email":"e2e_test@example.com"}
```

HTTP Status: **201 Created**

#### 3. Auth Service 로그인

```bash
curl -X POST http://localhost:18002/login \
  -H "Content-Type: application/json" \
  -d '{"username": "e2e_test_user", "password": "TestPass123@"}'
```

```json
{"status":"success","token":"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."}
```

HTTP Status: **200 OK**

#### 4. Auth Service 토큰 검증

```bash
curl http://localhost:18002/verify -H "Authorization: Bearer <TOKEN>"
```

```json
{"status":"success","data":{"user_id":1,"username":"e2e_test_user","exp":1769137140,"iat":1769050740,"jti":"2e7df05f-3c07-4ec0-8bce-6969afcf18ce","iss":"auth-service"}}
```

HTTP Status: **200 OK**

#### 5. Blog Service 포스트 목록 조회

```bash
curl http://localhost:18005/blog/api/posts
```

```json
[]
```

HTTP Status: **200 OK**

#### 6. Blog Service 포스트 생성 (FAIL)

```bash
curl -X POST http://localhost:18005/blog/api/posts \
  -H "Authorization: Bearer <TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{"title": "E2E Test Post", "content": "<p>E2E Test Content</p>", "category_name": "technology"}'
```

```json
{"error":"BadGateway","message":"Auth service not reachable","status_code":502}
```

HTTP Status: **502 Bad Gateway**

### 문제 원인 분석

Blog Service가 인증이 필요한 엔드포인트에서 Auth Service로 토큰 검증 요청을 보내야 하는데, NetworkPolicy에서 해당 egress 규칙이 누락됨.

**현재 Blog Service NetworkPolicy egress 규칙:**

```yaml
egress:
- ports:
  - port: 5432      # PostgreSQL
- ports:
  - port: 15012     # Istiod xDS-grpc
  - port: 15010     # Istiod xDS-grpc-cleartext
- ports:
  - port: 53/UDP    # kube-dns
```

**누락된 규칙:**

```yaml
- ports:
  - port: 8002
    protocol: TCP
  to:
  - podSelector:
      matchLabels:
        app: auth-service
```

### 조치 필요 사항

- Blog Service NetworkPolicy에 Auth Service (port 8002) egress 규칙 추가 필요
- 해당 수정 후 블로그 CRUD 기능 테스트 재수행 필요

---

## 8. 테스트 결과 업데이트

| 항목 | 기존 결과 | E2E 테스트 결과 | 최종 |
|------|----------|----------------|------|
| 인프라 상태 | PASS | - | PASS |
| 서비스 Health | PASS | PASS | PASS |
| 사용자 등록/로그인 | - | PASS | PASS |
| 토큰 인증 | - | PASS | PASS |
| 블로그 CRUD | - | **PARTIAL** | **PARTIAL** |

**전체 결과: PARTIAL PASS**

- 인프라 및 기본 서비스는 정상
- 인증이 필요한 블로그 쓰기 기능은 NetworkPolicy 수정 필요
