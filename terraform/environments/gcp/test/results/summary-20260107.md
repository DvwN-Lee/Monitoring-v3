# Terratest 실행 결과 Summary

## 실행 정보
- 실행 일시: 2026-01-07
- 실행 환경: GCP asia-northeast3
- 테스트 범위: Layer 3~5

## 테스트 결과 요약

| Layer | 테스트 | 결과 | 세부 결과 | 소요 시간 |
|-------|--------|------|----------|----------|
| 3 | TestComputeAndK3s | FAIL | 6/9 PASS | ~15분 |
| 3 | TestComputeIdempotency | FAIL | resourceNotReady | ~2분 |
| 4 | TestFullIntegration | FAIL | 6/6 PASS (cleanup 실패) | ~11분 |
| 5 | TestMonitoringStackValidation | FAIL | ArgoCD timeout | ~23분 |

---

## Layer 3: Compute & K3s 테스트

### 통과 항목 (6/9)
- MasterInstanceSpec: VM 사양 검증
- SSHConnectivity: SSH 연결성
- K3sServerStatus: K3s 서비스 상태
- K3sNodesReadyImproved: Node Ready 상태 (2/2)
- K3sSystemPods: CoreDNS, local-path-provisioner, metrics-server
- IAMLoggingPermission / IAMMonitoringPermission

### 실패 항목 (3/9)

#### 1. WorkerInstanceSpec / WorkerSpotInstance
- **원인**: MIG(Managed Instance Group)에서 생성된 Worker 인스턴스 이름 패턴 불일치
- **기대값**: `tt-abv6lv-worker-1`
- **실제값**: `tt-abv6lv-worker-xxxx` (MIG가 생성한 이름에 난수 포함)
- **파일**: `30_compute_k3s_test.go:186`, `30_compute_k3s_test.go:219`

#### 2. TestComputeIdempotency
- **원인**: 기존 인프라(titanium-k3s-*)와 테스트 인프라(tt-*) 간 리소스 충돌
- **오류**: `resourceNotReady` - Instance Group Manager 삭제 중 충돌
- **상세**: 테스트가 기존 인프라의 MIG를 삭제하려고 시도

---

## Layer 4: Full Integration 테스트

### 통과 항목 (6/6)
- InfrastructureOutputs: VPC, Subnet, IP 등 Output 검증
- KubeconfigAccess: kubectl 접근성 확인
- NamespaceSetup: argocd, monitoring, istio-system 등
- ArgoCDApplications: 7개 앱 배포 상태
- MonitoringStack: Prometheus, Grafana, Loki
- ApplicationEndpoints: HTTP 접근성 확인

### 실패 원인
- **Cleanup 단계 네트워크 오류**
- TLS handshake timeout
- http2: client connection lost
- GCS state 업로드 실패

---

## Layer 5: Monitoring Stack 테스트

### 실패 원인
- **ArgoCD Application `titanium-prod` timeout**
- 상태: `Progressing,OutOfSync` (10분 timeout 내 Healthy,Synced 미달성)
- 재시도 횟수: 60회 (10초 간격)

---

## 식별된 버그 및 개선 필요 사항

### Bug 1: Worker 인스턴스 이름 패턴 불일치
- **심각도**: Medium
- **파일**: `30_compute_k3s_test.go`
- **설명**: MIG에서 생성된 Worker 인스턴스 이름에 난수가 포함되어 하드코딩된 이름(`worker-1`)과 불일치
- **해결 방안**: `gcloud compute instance-groups managed list-instances`를 사용하여 동적으로 인스턴스 이름 조회

### Bug 2: State 충돌로 인한 멱등성 테스트 실패
- **심각도**: High
- **파일**: `helpers.go`, `30_compute_k3s_test.go`
- **설명**: 테스트가 기존 인프라와 동일한 Terraform state를 공유하여 충돌 발생
- **해결 방안**: 테스트용 격리된 state backend 사용 또는 테스트 전용 cluster_name 강제 적용

### Bug 3: ArgoCD Application 동기화 시간 초과
- **심각도**: Medium
- **파일**: `50_monitoring_stack_test.go`
- **설명**: titanium-prod Application이 10분 내에 Healthy,Synced 상태에 도달하지 못함
- **해결 방안**: timeout 증가 또는 Application 배포 순서 최적화

---

## 로그 파일 경로
- Layer 3: `results/layer03-compute-20260107-142600.log`
- Layer 4: `results/layer04-integration-20260107-144500.log`
- Layer 5: `results/layer05-monitoring-20260107-145700.log`
- Terraform Apply: `results/terraform-apply-20260107-142400.log`
