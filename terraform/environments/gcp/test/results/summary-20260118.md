# IaC 멱등성 테스트 및 서비스 테스트 결과 보고서

**실행 일시:** 2026-01-18
**PR 대상:** #59 Merge 이후 변경 사항 검증

---

## 테스트 결과 요약

| 테스트 | 상태 | 소요 시간 | 비고 |
|--------|------|-----------|------|
| IaC Static Validation (Layer 0-1) | **PASS** | 6.38s | 14/14 테스트 통과 |
| Compute Idempotency (Layer 3) | **PASS** | 387.21s | 멱등성 검증 완료 |
| Monitoring Stack (Layer 5) | **FAIL** | 2035.79s | Istio sidecar 초기화 이슈 |
| Service Smoke | **SKIP** | - | Cluster 미실행 |
| Dashboard UI | **SKIP** | - | Cluster 미실행 |
| Integration | **SKIP** | - | Cluster 미실행 |

---

## 1. IaC Static Validation (Layer 0-1) - PASS

### 실행 명령어
```bash
go test -v -run "TestTerraform|TestPlan" -timeout 10m
```

### 통과 테스트 목록
- `TestTerraformFormat` - Terraform 코드 포맷 검증
- `TestTerraformValidate` - Terraform 구문 유효성 검증
- `TestPlanResourceCount` - Resource 수량 확인
- `TestPlanNetworkConfig` - 네트워크 설정 검증
- `TestPlanComputeConfig` - Compute 설정 검증
- `TestPlanFirewallRules` - Firewall 규칙 검증
- `TestPlanOutputDefinitions` - Output 정의 검증
- `TestPlanNoSensitiveHardcoding` - 민감 정보 하드코딩 검증
- `TestPlanInvalidInputs` (4개 서브테스트)
  - `InvalidMachineType`
  - `NegativeWorkerCount`
  - `InvalidRegion`
  - `EmptyProjectID`
- `TestPlanFirewallSourceRanges` - Firewall Source Range 검증
- `TestPlanFirewallNoWideOpen` - 0.0.0.0/0 규칙 차단 확인

---

## 2. Compute Idempotency (Layer 3) - PASS

### 실행 명령어
```bash
go test -v -run "TestComputeIdempotency" -timeout 30m
```

### 검증 내용
- Terraform apply 2회 실행 시 변경 사항 없음 확인
- Resource drift 없음
- State 격리 (`GetIsolatedTerraformOptions()`) 정상 동작

### 생성/삭제된 리소스
- VPC: `tt-XXXXX-vpc`
- Subnet: `tt-XXXXX-subnet`
- Master VM: `tt-XXXXX-master`
- Worker MIG: `tt-XXXXX-worker-mig`
- Firewall Rules: 5개

---

## 3. Monitoring Stack (Layer 5) - FAIL

### 실행 명령어
```bash
go test -v -run "TestMonitoringStackValidation" -timeout 60m
```

### 실패 원인
ArgoCD titanium-prod Application이 `Degraded` 상태에서 벗어나지 못함.

### 상세 분석

#### Pod 상태
```
NAME                                            READY   STATUS    RESTARTS
prod-api-gateway-deployment-6dbcccc95f-6cbqx    1/2     Running   0
prod-api-gateway-deployment-6dbcccc95f-hfkhw    1/2     Running   0
prod-auth-service-deployment-6d8f9c6b45-gz9gj   1/2     Running   0
prod-auth-service-deployment-6d8f9c6b45-x7xwq   1/2     Running   0
prod-blog-service-deployment-ff7b469f7-92pl4    1/2     Running   1
prod-blog-service-deployment-ff7b469f7-xnhxg    1/2     Running   1
prod-postgresql-0                               1/1     Running   0
prod-redis-deployment-5dbbf68969-brqjq          1/2     Running   0
prod-user-service-deployment-6456bbd446-4hmxb   1/2     Running   1
prod-user-service-deployment-6456bbd446-v9jkn   1/2     Running   1
```

#### 문제점
- READY가 `1/2`인 Pod들: Istio sidecar가 준비되지 않음
- Startup probe가 Istio sidecar 포트(15021)에서 실패

#### Warning Events
```
Startup probe failed: Get "http://10.42.x.x:15021/healthz/ready": dial tcp: connection refused
```

#### Node Resource 상태 (정상)
```
NAME                                    CPU(cores)   CPU(%)   MEMORY(bytes)   MEMORY(%)
terratest-ai4fzc-master                 261m         13%      2202Mi          56%
terratest-ai4fzc-worker-9s6h-63c99331   176m         4%       1186Mi          7%
terratest-ai4fzc-worker-z90q-3da33a7c   137m         3%       1088Mi          6%
```

### 근본 원인
Istio sidecar 초기화 지연 또는 실패. 모든 Pod가 Running 상태이나 Istio sidecar container가 Ready 상태로 전환되지 않음.

---

## 버그 수정 내역

### helpers.go logDegradedDebugInfo namespace 버그

**파일:** `terraform/environments/gcp/test/helpers.go`

**문제:**
- Degraded 상태 디버깅 시 `default` namespace 대신 `titanium-prod` namespace를 조회해야 함

**수정:**
```go
// 수정 전
func logDegradedDebugInfo(t *testing.T, host ssh.Host, appName string)

// 수정 후
func logDegradedDebugInfo(t *testing.T, host ssh.Host, appName string, namespace string)
```

호출부: `logDegradedDebugInfo(t, host, appName, NamespaceProd)`

**결과:**
- 버그 수정이 정상 동작하여 이번 테스트에서 titanium-prod namespace의 실제 Pod 상태 출력
- Istio sidecar 문제 식별 가능

---

## 후속 작업

1. **Istio sidecar 초기화 이슈 조사**
   - Istio Proxy 시작 지연 원인 분석
   - PeerAuthentication 설정 검토
   - Startup probe timeout 조정 검토

2. **Monitoring Stack 테스트 재실행**
   - Istio 설정 수정 후 재시도
   - 또는 Istio sidecar 타임아웃 증가 고려

3. **K3s Production Cluster 배포**
   - Production Cluster 재배포 후 Phase 2-4 테스트 진행

---

## 결론

| 항목 | 결과 |
|------|------|
| IaC 코드 품질 | **PASS** - Static Validation 및 멱등성 테스트 통과 |
| 버그 수정 | **PASS** - `logDegradedDebugInfo` namespace 버그 수정 완료 및 동작 확인 |
| Monitoring Stack | **FAIL** - Istio sidecar 초기화 이슈 (코드 문제 아님) |

**요약:**
- Terraform IaC 코드는 안정적으로 동작
- 버그 수정이 효과적으로 적용되어 디버깅 정보 정확도 향상
- Monitoring Stack 실패는 Istio sidecar 레이어 문제로, 인프라 코드 이슈가 아님
